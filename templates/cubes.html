{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–ö—É–±–∏–∫ –º—É–∑—ã–∫–∞</h2>
    {% if session.role == 'admin' %}
        <a href="{{ url_for('add_cube') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫—É–±–∏–∫</a>
    {% endif %}
</div>

<form method="GET" action="{{ url_for('cube_search') }}" class="mb-4">
    <div class="input-group">
        <input type="text" name="q" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –ª–∏—Ü–µ–Ω–∑–∏–∏, –¥–æ–≥–æ–≤–æ—Ä—É, –æ–±—ä–µ–∫—Ç—É –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–º—É –ª–∏—Ü—É..." 
               value="{{ search_query or '' }}">
        <button class="btn btn-outline-secondary" type="submit">–ù–∞–π—Ç–∏</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>–ü—Ä–æ–≥—Ä–∞–º–º–∞</th>
                <th>–£—Å–ª—É–≥–∞</th>
                <th>–î–æ–≥–æ–≤–æ—Ä</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <th>–û–±—ä–µ–∫—Ç</th>
                <th>–ì–æ—Ä–æ–¥</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                {% if session.role == 'admin' %}
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for cube in cubes %}
            <tr>
                <td>
                    <strong>{{ cube.name }}</strong>
                    {% if cube.notes %}
                        <br><small class="text-muted">{{ cube.notes }}</small>
                    {% endif %}
                </td>
                <td>{{ cube.software_type }}</td>
                <td>
                    <span class="badge bg-secondary">{{ cube.license_type }}</span>
                </td>
                <td>
                    {% if cube.license_key %}
                        <strong>–ö–ª—é—á:</strong> {{ cube.license_key }}<br>
                    {% endif %}
                    {% if cube.contract_number %}
                        <strong>–î–æ–≥.:</strong> {{ cube.contract_number }}
                        {% if cube.contract_date %}
                            <br><small class="text-muted">–æ—Ç {{ cube.contract_date }}</small>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-info">{{ cube.users_count }} </span>
                </td>
                <td>
                    {% if cube.price and cube.price > 0 %}
                        {{ "‚ÇΩ{:,.2f}".format(cube.price).replace(',', ' ') }}
                    {% else %}
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
                    {% endif %}
                </td>
                <td>{{ cube.object_location }}</td>
                <td>
                    <span class="badge bg-info text-dark">{{ cube.city }}</span>
                </td>
                <td>
                    <span class="badge 
                        {% if cube.status == '–ê–∫—Ç–∏–≤–µ–Ω' %}bg-success
                        {% elif cube.status == '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' %}bg-warning
                        {% else %}bg-secondary{% endif %}">
                        {{ cube.status }}
                    </span>
                </td>
    
                <td>
                    {% if cube.support_contact %}
                        <strong>{{ cube.support_contact }}</strong><br>
                    {% endif %}
                    {% if cube.phone %}
                        üìû {{ cube.phone }}<br>
                    {% endif %}
                    {% if cube.email %}
                        ‚úâÔ∏è {{ cube.email }}
                    {% endif %}
                </td>
                {% if session.role == 'admin' %}
                    <td>
                        <a href="{{ url_for('edit_cube', cube_id=cube.id) }}" class="btn btn-sm btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <a href="{{ url_for('delete_cube', cube_id=cube.id) }}" class="btn btn-sm btn-outline-danger" 
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫—É–±–∏–∫?')">–£–¥–∞–ª–∏—Ç—å</a>
                    </td>
                {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="{% if session.role == 'admin' %}12{% else %}11{% endif %}" class="text-center">–ö—É–±–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫—É–±–∏–∫–∞–º -->
<div class="row mt-5">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ü–û</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><strong>–í—Å–µ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º:</strong> {{ cubes|length }}</li>
                    <li><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö:</strong> {{ cubes|selectattr('status', 'equalto', '–ê–∫—Ç–∏–≤–µ–Ω')|list|length }}</li>
                    <li><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> 
                        {{ "‚ÇΩ{:,.2f}".format(cubes|sum(attribute='price')).replace(',', ' ') }}
                    </li>
                    <!--<li><strong>–í—Å–µ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–π:</strong> {{ cubes|sum(attribute='users_count') }}</li>-->
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}