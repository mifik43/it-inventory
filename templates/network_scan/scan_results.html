{% extends "base/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Результаты сканирования: {{ scan.name }}</h1>
        <div class="btn-group">
            <a href="{{ url_for('network_scan') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад
            </a>
            <a href="{{ url_for('network_devices') }}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> Все устройства
            </a>
        </div>
    </div>

    <!-- Информация о сканировании -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle"></i> Информация о сканировании
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Тип сканирования:</strong><br>
                            <span class="badge bg-info">{{ scan.scan_type }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Целевая сеть:</strong><br>
                            <code>{{ scan.target_range }}</code>
                        </div>
                        <div class="col-md-3">
                            <strong>Найдено устройств:</strong><br>
                            <span class="badge bg-success">{{ scan.devices_found }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Статус:</strong><br>
                            {% if scan.status == 'completed' %}
                            <span class="badge bg-success">Завершено</span>
                            {% elif scan.status == 'running' %}
                            <span class="badge bg-warning">В процессе</span>
                            {% else %}
                            <span class="badge bg-danger">{{ scan.status }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <strong>Создано:</strong><br>
                            {% if scan.created_at %}
                                {% if scan.created_at is string %}
                                    {{ scan.created_at[:16] }}
                                {% else %}
                                    {{ scan.created_at.strftime('%d.%m.%Y %H:%M') }}
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <strong>Завершено:</strong><br>
                            {% if scan.completed_at %}
                                {% if scan.completed_at is string %}
                                    {{ scan.completed_at[:16] }}
                                {% else %}
                                    {{ scan.completed_at.strftime('%d.%m.%Y %H:%M') }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Примечания:</strong><br>
                            {{ scan.notes or 'Нет примечаний' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ devices|length }}</h3>
                    <p class="text-muted mb-0">Устройств найдено</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">
                        {{ devices|selectattr('response_time', 'defined')|list|length }}
                    </h3>
                    <p class="text-muted mb-0">Отвечают на ping</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">
                        {{ devices|selectattr('ports', 'defined')|selectattr('ports', 'length')|list|length }}
                    </h3>
                    <p class="text-muted mb-0">С открытыми портами</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">
                        {{ devices|selectattr('hostname', 'ne', 'Unknown')|list|length }}
                    </h3>
                    <p class="text-muted mb-0">С определенным именем</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Список устройств -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-network-wired"></i> Обнаруженные устройства
            </h5>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Экспорт CSV
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if devices %}
            <div class="table-responsive">
                <table class="table table-striped" id="devices-table">
                    <thead>
                        <tr>
                            <th>IP-адрес</th>
                            <th>MAC-адрес</th>
                            <th>Имя хоста</th>
                            <th>Производитель</th>
                            <th>Порты</th>
                            <th>Время ответа</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr>
                            <td>
                                <strong>{{ device.ip_address }}</strong>
                                {% if device.hostname != 'Unknown' %}
                                <br><small class="text-muted">{{ device.hostname }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <code>{{ device.mac_address }}</code>
                                {% if device.vendor != 'Unknown' %}
                                <br><small class="text-muted">{{ device.vendor }}</small>
                                {% endif %}
                            </td>
                            <td>{{ device.hostname }}</td>
                            <td>
                                {% if device.vendor != 'Unknown' %}
                                <span class="badge bg-info">{{ device.vendor }}</span>
                                {% else %}
                                <span class="text-muted">Неизвестно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.ports and device.ports|length > 0 %}
                                    <div class="port-badges">
                                        {% for port in device.ports %}
                                            {% if port in [21, 22, 23, 80, 443, 3389, 8080] %}
                                                {% set badge_class = 'bg-warning' %}
                                            {% else %}
                                                {% set badge_class = 'bg-secondary' %}
                                            {% endif %}
                                            <span class="badge {{ badge_class }} me-1 mb-1" 
                                                  title="{{ get_port_service(port) }}">
                                                {{ port }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Нет данных</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.response_time and device.response_time > 0 %}
                                    <span class="badge bg-success">{{ device.response_time }} мс</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-success">Online</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info" 
                                            onclick="pingDevice('{{ device.ip_address }}')"
                                            title="Пинговать устройство">
                                        <i class="fas fa-satellite-dish"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            onclick="scanPorts('{{ device.ip_address }}')"
                                            title="Сканировать порты">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    {% if session.role == 'admin' %}
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteDevice({{ device.id }})"
                                            title="Удалить устройство">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Устройства не найдены</h5>
                <p class="text-muted">Попробуйте изменить параметры сканирования</p>
                <a href="{{ url_for('network_scan') }}" class="btn btn-primary">
                    <i class="fas fa-radar"></i> Новое сканирование
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для пинга -->
<div class="modal fade" id="pingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пинг устройства</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ping-result"></div>
            </div>
        </div>
    </div>
</div>

<style>
.port-badges {
    max-width: 200px;
}
.badge {
    font-size: 0.7em;
}
</style>

<script>
function get_port_service(port) {
    const portServices = {
        21: 'FTP',
        22: 'SSH',
        23: 'Telnet',
        25: 'SMTP',
        53: 'DNS',
        80: 'HTTP',
        110: 'POP3',
        143: 'IMAP',
        443: 'HTTPS',
        993: 'IMAPS',
        995: 'POP3S',
        1433: 'MSSQL',
        1521: 'Oracle',
        3306: 'MySQL',
        3389: 'RDP',
        5432: 'PostgreSQL',
        5900: 'VNC',
        8080: 'HTTP-Alt'
    };
    return portServices[port] || 'Unknown';
}

function pingDevice(ip) {
    const pingResult = document.getElementById('ping-result');
    pingResult.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Пингую ' + ip + '...</div>';
    
    const modal = new bootstrap.Modal(document.getElementById('pingModal'));
    modal.show();
    
    fetch('/network_scan/ping/' + ip)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                pingResult.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Устройство отвечает</h6>
                        <p>IP: ${data.ip}<br>Время ответа: ${data.response_time} мс</p>
                    </div>
                `;
            } else {
                pingResult.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Устройство не отвечает</h6>
                        <p>IP: ${data.ip}<br>Ошибка: ${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            pingResult.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Ошибка</h6>
                    <p>${error}</p>
                </div>
            `;
        });
}

function scanPorts(ip) {
    alert('Сканирование портов для ' + ip + ' будет доступно в следующей версии');
}

function deleteDevice(deviceId) {
    if (confirm('Удалить устройство из базы данных?')) {
        fetch('/network_scan/delete_device/' + deviceId, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            });
    }
}

function exportToCSV() {
    let csv = 'IP Address,MAC Address,Hostname,Vendor,Ports,Response Time\n';
    
    document.querySelectorAll('#devices-table tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        const ip = cells[0].querySelector('strong').textContent.trim();
        const mac = cells[1].querySelector('code').textContent.trim();
        const hostname = cells[2].textContent.trim();
        const vendor = cells[3].textContent.trim();
        const ports = Array.from(cells[4].querySelectorAll('.badge')).map(b => b.textContent).join(';');
        const responseTime = cells[5].textContent.trim();
        
        csv += `"${ip}","${mac}","${hostname}","${vendor}","${ports}","${responseTime}"\n`;
    });
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'network_devices_{{ scan.id }}.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}