{% extends "base/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Все сетевые устройства</h1>
        <div class="btn-group">
            <a href="{{ url_for('network_scan.network_scan') }}" class="btn btn-primary">
                <i class="fas fa-radar"></i> Новое сканирование
            </a>
            <button class="btn btn-outline-success" onclick="exportAllToCSV()">
                <i class="fas fa-download"></i> Экспорт
            </button>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filter-form" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">IP-адрес</label>
                    <input type="text" class="form-control" id="filter-ip" placeholder="192.168...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Производитель</label>
                    <input type="text" class="form-control" id="filter-vendor" placeholder="Cisco, D-Link...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Статус</label>
                    <select class="form-select" id="filter-status">
                        <option value="">Все</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="button" class="btn btn-outline-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Применить
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Сбросить
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ devices|length }}</h3>
                    <p class="text-muted mb-0">Всего устройств</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ devices|selectattr('response_time', 'gt', 0)|list|length }}</h3>
                    <p class="text-muted mb-0">Активные</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ vendors_count }}</h3>
                    <p class="text-muted mb-0">Производителей</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ devices|selectattr('ports', 'defined')|selectattr('ports', 'length')|list|length }}</h3>
                    <p class="text-muted mb-0">С портами</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-secondary">{{ scans_count }}</h3>
                    <p class="text-muted mb-0">Сканирований</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-dark">{{ last_scan_date }}</h3>
                    <p class="text-muted mb-0">Последнее сканирование</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Список устройств -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-network-wired"></i> Обнаруженные устройства
            </h5>
            <span class="badge bg-primary" id="device-count">{{ devices|length }} устройств</span>
        </div>
        <div class="card-body">
            {% if devices %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="devices-table">
                    <thead>
                        <tr>
                            <th>IP-адрес</th>
                            <th>MAC-адрес</th>
                            <th>Имя хоста</th>
                            <th>Производитель</th>
                            <th>Порты</th>
                            <th>Время ответа</th>
                            <th>Обнаружено</th>
                            <th>Сканирование</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr class="device-row" 
                            data-ip="{{ device.ip_address }}"
                            data-vendor="{{ device.vendor }}"
                            data-status="{% if device.response_time and device.response_time > 0 %}online{% else %}offline{% endif %}">
                            <td>
                                <strong>{{ device.ip_address }}</strong>
                                {% if device.hostname != 'Unknown' %}
                                <br><small class="text-muted">{{ device.hostname }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <code>{{ device.mac_address }}</code>
                            </td>
                            <td>{{ device.hostname }}</td>
                            <td>
                                {% if device.vendor != 'Unknown' %}
                                <span class="badge bg-info">{{ device.vendor }}</span>
                                {% else %}
                                <span class="text-muted">Неизвестно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.ports and device.ports|length > 0 %}
                                    <div class="port-badges">
                                        {% for port in device.ports|sort %}
                                            {% if port in [21, 22, 23, 80, 443, 3389, 8080] %}
                                                {% set badge_class = 'bg-warning' %}
                                            {% else %}
                                                {% set badge_class = 'bg-secondary' %}
                                            {% endif %}
                                            <span class="badge {{ badge_class }} me-1 mb-1">
                                                {{ port }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if device.response_time and device.response_time > 0 %}
                                    <span class="badge bg-success">{{ device.response_time }} мс</span>
                                {% else %}
                                    <span class="badge bg-secondary">Нет данных</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>
                                    {% if device.last_seen %}
                                        {% if device.last_seen is string %}
                                            {{ device.last_seen[:10] }}
                                        {% else %}
                                            {{ device.last_seen.strftime('%d.%m.%Y') }}
                                        {% endif %}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <small>{{ device.scan_name }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-info" 
                                            onclick="pingDevice('{{ device.ip_address }}')"
                                            title="Пинговать">
                                        <i class="fas fa-satellite-dish"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            onclick="showDeviceInfo({{ device.id }})"
                                            title="Информация">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    {% if session.role == 'admin' %}
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteDevice({{ device.id }})"
                                            title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Устройства не найдены</h5>
                <p class="text-muted">Запустите сканирование сети для обнаружения устройств</p>
                <a href="{{ url_for('network_scan.network_scan') }}" class="btn btn-primary">
                    <i class="fas fa-radar"></i> Запустить сканирование
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно информации об устройстве -->
<div class="modal fade" id="deviceInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Информация об устройстве</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="device-info-content">
                <!-- Контент будет загружен динамически -->
            </div>
        </div>
    </div>
</div>

<style>
.port-badges {
    max-width: 150px;
}
.badge {
    font-size: 0.7em;
}
.device-row.offline {
    opacity: 0.6;
    background-color: #f8f9fa;
}
</style>

<script>
function applyFilters() {
    const ipFilter = document.getElementById('filter-ip').value.toLowerCase();
    const vendorFilter = document.getElementById('filter-vendor').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;
    
    let visibleCount = 0;
    
    document.querySelectorAll('.device-row').forEach(row => {
        const ip = row.getAttribute('data-ip').toLowerCase();
        const vendor = row.getAttribute('data-vendor').toLowerCase();
        const status = row.getAttribute('data-status');
        
        const ipMatch = !ipFilter || ip.includes(ipFilter);
        const vendorMatch = !vendorFilter || vendor.includes(vendorFilter);
        const statusMatch = !statusFilter || status === statusFilter;
        
        if (ipMatch && vendorMatch && statusMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    document.getElementById('device-count').textContent = visibleCount + ' устройств';
}

function clearFilters() {
    document.getElementById('filter-ip').value = '';
    document.getElementById('filter-vendor').value = '';
    document.getElementById('filter-status').value = '';
    applyFilters();
}

function showDeviceInfo(deviceId) {
    const content = document.getElementById('device-info-content');
    content.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>';
    
    const modal = new bootstrap.Modal(document.getElementById('deviceInfoModal'));
    modal.show();
    
    fetch('/network_scan/device_info/' + deviceId)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Основная информация</h6>
                            <table class="table table-sm">
                                <tr><td><strong>IP-адрес:</strong></td><td>${data.device.ip_address}</td></tr>
                                <tr><td><strong>MAC-адрес:</strong></td><td><code>${data.device.mac_address}</code></td></tr>
                                <tr><td><strong>Имя хоста:</strong></td><td>${data.device.hostname}</td></tr>
                                <tr><td><strong>Производитель:</strong></td><td>${data.device.vendor}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Сетевые характеристики</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Время ответа:</strong></td><td>${data.device.response_time || 'Нет данных'} мс</td></tr>
                                <tr><td><strong>Статус:</strong></td><td><span class="badge bg-success">Online</span></td></tr>
                                <tr><td><strong>Последнее обнаружение:</strong></td><td>${data.device.last_seen}</td></tr>
                                <tr><td><strong>Сканирование:</strong></td><td>${data.device.scan_name}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${data.device.ports && data.device.ports.length > 0 ? `
                    <div class="mt-3">
                        <h6>Открытые порты</h6>
                        <div class="port-badges">
                            ${data.device.ports.map(port => `<span class="badge bg-warning me-1">${port}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;
            } else {
                content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            }
        })
        .catch(error => {
            content.innerHTML = `<div class="alert alert-danger">Ошибка: ${error}</div>`;
        });
}

function pingDevice(ip) {
    alert('Пинг устройства ' + ip + ' выполняется...');
    // Реализация пинга будет добавлена в следующих версиях
}

function deleteDevice(deviceId) {
    if (confirm('Удалить устройство из базы данных?')) {
        fetch('/network_scan/delete_device/' + deviceId, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + data.error);
                }
            });
    }
}

function exportAllToCSV() {
    let csv = 'IP Address,MAC Address,Hostname,Vendor,Ports,Response Time,Last Seen,Scan\n';
    
    document.querySelectorAll('#devices-table tbody tr').forEach(row => {
        if (row.style.display !== 'none') {
            const cells = row.querySelectorAll('td');
            const ip = cells[0].querySelector('strong').textContent.trim();
            const mac = cells[1].querySelector('code').textContent.trim();
            const hostname = cells[2].textContent.trim();
            const vendor = cells[3].textContent.trim();
            const ports = Array.from(cells[4].querySelectorAll('.badge')).map(b => b.textContent).join(';');
            const responseTime = cells[5].textContent.trim();
            const lastSeen = cells[6].textContent.trim();
            const scan = cells[7].textContent.trim();
            
            csv += `"${ip}","${mac}","${hostname}","${vendor}","${ports}","${responseTime}","${lastSeen}","${scan}"\n`;
        }
    });
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'all_network_devices.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Автоматическое применение фильтров при изменении полей
document.getElementById('filter-ip').addEventListener('input', applyFilters);
document.getElementById('filter-vendor').addEventListener('input', applyFilters);
document.getElementById('filter-status').addEventListener('change', applyFilters);
</script>
{% endblock %}