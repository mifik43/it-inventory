{% extends "base/base.html" %}

{% block title %}Создать статью{% endblock %}

{% block styles %}
<style>
.screenshot-preview {
    max-height: 150px;
    object-fit: cover;
}
.screenshot-card {
    transition: transform 0.2s;
}
.screenshot-card:hover {
    transform: translateY(-2px);
}
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s;
}
.upload-area:hover {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}
.upload-area.dragover {
    border-color: #0d6efd;
    background-color: #d4e6ff;
}
.upload-preview {
    max-width: 100px;
    max-height: 100px;
    object-fit: cover;
    border-radius: 0.375rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('articles.articles_list') }}">Статьи</a></li>
                <li class="breadcrumb-item active">Создание статьи</li>
            </ol>
        </nav>

        <h2>Создать новую статью</h2>
        
        <form method="POST" enctype="multipart/form-data" id="articleForm">
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        <label for="title" class="form-label">Заголовок статьи *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="category" class="form-label">Категория *</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="Общее">Общее</option>
                            <option value="Инструкции">Инструкции</option>
                            <option value="Проблемы">Проблемы</option>
                            <option value="Решения">Решения</option>
                            <option value="Оборудование">Оборудование</option>
                            <option value="ПО">ПО</option>
                            <option value="Сеть">Сеть</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="tags" class="form-label">Теги</label>
                <input type="text" class="form-control" id="tags" name="tags" 
                       placeholder="тег1,тег2,тег3">
                <div class="form-text">Укажите теги через запятую</div>
            </div>

            <div class="mb-3">
                <label for="content" class="form-label">Содержание статьи *</label>
                <textarea class="form-control" id="content" name="content" rows="15" required></textarea>
            </div>

            <!-- Блок загрузки скриншотов -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-images"></i> Скриншоты
                        <span class="badge bg-primary ms-2" id="screenshotsCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Область загрузки -->
                <div class="upload-area mb-4" id="uploadArea">
                    <i class="bi bi-cloud-arrow-up display-4 text-muted mb-3"></i>
                    <h5>Добавьте скриншоты к статье</h5>
                    <p class="text-muted">Перетащите файлы или нажмите для выбора</p>
                    <input type="file" id="screenshots" name="screenshots" 
                        multiple accept="image/png, image/jpeg, image/jpg, image/gif, image/bmp, image/webp" 
                        class="d-none">
                    <div class="mt-3">
                        <span class="badge bg-info me-2">PNG</span>
                        <span class="badge bg-info me-2">JPG</span>
                        <span class="badge bg-info me-2">GIF</span>
                        <span class="badge bg-info me-2">WEBP</span>
                    </div>
                    <div class="form-text mt-2">
                        <i class="bi bi-info-circle"></i> Максимальный размер файла: 16MB. Рекомендуемое разрешение: до 1920x1080px.
                    </div>
                </div>

                    <!-- Прелоадер -->
                    <div id="uploadProgress" class="d-none">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Обработка файлов...</span>
                        </div>
                    </div>

                    <!-- Предпросмотр выбранных файлов -->
                    <div id="filePreviews" class="row mb-3 d-none">
                        <div class="col-12">
                            <h6>Выбранные файлы:</h6>
                            <div id="previewsContainer" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <!-- Сообщение, если файлы не выбраны -->
                    <div class="text-center py-4" id="noScreenshots">
                        <i class="bi bi-image display-1 text-muted"></i>
                        <p class="text-muted mt-2">Скриншоты не добавлены</p>
                    </div>
                </div>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="is_published" name="is_published" value="1" checked>
                <label class="form-check-label" for="is_published">Опубликовать статью</label>
            </div>
            
            <button type="submit" class="btn btn-primary">Опубликовать статью</button>
            <a href="{{ url_for('articles.articles_list') }}" class="btn btn-secondary">Отмена</a>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('screenshots');
    const uploadProgress = document.getElementById('uploadProgress');
    const filePreviews = document.getElementById('filePreviews');
    const previewsContainer = document.getElementById('previewsContainer');
    const noScreenshots = document.getElementById('noScreenshots');
    const screenshotsCount = document.getElementById('screenshotsCount');
    const form = document.getElementById('articleForm');

    let selectedFiles = [];

    // Обработка клика по области загрузки
    uploadArea.addEventListener('click', () => fileInput.click());

    // Обработка перетаскивания файлов
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // Обработка выбора файлов через input
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        if (files.length > 0) {
            uploadProgress.classList.remove('d-none');
            
            // Обрабатываем файлы
            Array.from(files).forEach(file => {
                if (isValidFile(file)) {
                    selectedFiles.push(file);
                    createFilePreview(file);
                }
            });

            // Обновляем интерфейс
            updateUI();
            
            uploadProgress.classList.add('d-none');
        }
    }

    function isValidFile(file) {
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/webp'];
        const maxSize = 16 * 1024 * 1024; // 16MB

        if (!allowedTypes.includes(file.type)) {
            alert(`Файл "${file.name}" имеет неподдерживаемый формат.`);
            return false;
        }

        if (file.size > maxSize) {
            alert(`Файл "${file.name}" слишком большой. Максимальный размер: 16MB.`);
            return false;
        }

        return true;
    }

    function createFilePreview(file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.createElement('div');
            preview.className = 'position-relative d-inline-block me-2 mb-2';
            preview.innerHTML = `
                <img src="${e.target.result}" class="upload-preview" alt="${file.name}">
                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" 
                        onclick="removeFilePreview(this, '${file.name}')">
                    <i class="bi bi-x"></i>
                </button>
                <div class="small text-center mt-1">${file.name}</div>
            `;
            previewsContainer.appendChild(preview);
        };
        
        reader.readAsDataURL(file);
    }

    function updateUI() {
        const count = selectedFiles.length;
        screenshotsCount.textContent = count;
        
        if (count > 0) {
            filePreviews.classList.remove('d-none');
            noScreenshots.style.display = 'none';
        } else {
            filePreviews.classList.add('d-none');
            noScreenshots.style.display = 'block';
        }
    }

    // Глобальная функция для удаления превью
    window.removeFilePreview = function(button, fileName) {
        // Удаляем файл из массива
        selectedFiles = selectedFiles.filter(file => file.name !== fileName);
        
        // Удаляем превью
        button.closest('.position-relative').remove();
        
        // Обновляем интерфейс
        updateUI();
    };

    // Обработка отправки формы
    form.addEventListener('submit', function(e) {
        // Создаем FormData и добавляем файлы
        const formData = new FormData(form);
        
        // Очищаем существующие файлы в FormData и добавляем выбранные
        formData.delete('screenshots');
        selectedFiles.forEach(file => {
            formData.append('screenshots', file);
        });

        // Можно добавить здесь индикатор загрузки
        uploadProgress.classList.remove('d-none');
        uploadProgress.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span>Создание статьи и загрузка ${selectedFiles.length} скриншотов...</span>
            </div>
        `;

        // Отправляем форму через fetch для лучшего контроля
        e.preventDefault();
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            uploadProgress.classList.add('d-none');
            alert('Ошибка при создании статьи. Пожалуйста, попробуйте еще раз.');
        });
    });

    // Скрываем сообщение "нет скриншотов" если они есть
    if (selectedFiles.length > 0) {
        noScreenshots.style.display = 'none';
    }
});

// Добавьте эту функцию в блок <script>
function validateFilesBeforeUpload(files) {
    const errors = [];
    const maxSize = 16 * 1024 * 1024; // 16MB
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/webp'];
    
    Array.from(files).forEach(file => {
        // Проверка типа файла
        if (!allowedTypes.includes(file.type)) {
            errors.push(`"${file.name}" - неподдерживаемый формат`);
            return;
        }
        
        // Проверка размера файла
        if (file.size > maxSize) {
            errors.push(`"${file.name}" - слишком большой файл (${(file.size / (1024*1024)).toFixed(1)}MB)`);
            return;
        }
        
        // Проверка на дубликаты
        if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            errors.push(`"${file.name}" - файл уже добавлен`);
        }
    });
    
    return errors;
}

// Обновите функцию handleFiles
function handleFiles(files) {
    if (files.length > 0) {
        const errors = validateFilesBeforeUpload(files);
        
        if (errors.length > 0) {
            alert('Ошибки при загрузке файлов:\n' + errors.join('\n'));
            return;
        }
        
        uploadProgress.classList.remove('d-none');
        
        // Обрабатываем файлы
        Array.from(files).forEach(file => {
            selectedFiles.push(file);
            createFilePreview(file);
        });

        // Обновляем интерфейс
        updateUI();
        
        uploadProgress.classList.add('d-none');
        
        // Очищаем input для возможности повторного выбора тех же файлов
        fileInput.value = '';
    }
}
</script>
{% endblock %}